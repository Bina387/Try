<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gemini-Style AI Pro</title>
  
  <script src="https://js.puter.com/v2/"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #1a1a2e, #16213e);
      --header-bg: rgba(0, 0, 0, 0.7);
      --user-msg: #0078ff;
      --bot-msg: #252533;
      --text-color: #e0e0e0;
      --accent: #00d4ff;
    }

    body.light {
      --bg-gradient: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      --header-bg: rgba(255, 255, 255, 0.9);
      --user-msg: #0078ff;
      --bot-msg: #ffffff;
      --text-color: #1a1a2e;
      --accent: #0078ff;
    }

    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg-gradient);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      height: 100vh;
      transition: all 0.3s ease;
    }

    header {
      padding: 15px 25px;
      background: var(--header-bg);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.7);
      z-index: 100;
    }

    .brand { font-size: 1.5rem; font-weight: 800; background: linear-gradient(to right, #00d4ff, #0078ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    .nav-tools button {
      background: none; border: none; color: var(--text-color);
      font-size: 1.3rem; cursor: pointer; margin-left: 15px; transition: transform 0.2s;
    }
    .nav-tools button:hover { transform: translateY(-2px); color: var(--accent); }

    #chat-container {
      flex: 1; overflow-y: auto; padding: 20px;
      display: flex; flex-direction: column; gap: 20px;
    }

    .message {
      max-width: 85%; padding: 14px 18px; border-radius: 18px;
      line-height: 1.6; position: relative; animation: slideUp 0.4s ease-out;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    .user { background: var(--user-msg); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
    .bot { background: var(--bot-msg); color: var(--text-color); align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,0.05); }

    /* Code Block Styling */
    pre { background: #0d1117; padding: 15px; border-radius: 10px; overflow-x: auto; margin: 10px 0; }
    code { font-family: 'Fira Code', monospace; font-size: 0.9em; }

    #input-area {
      padding: 20px; background: var(--header-bg); border-top: 1px solid rgba(255,255,255,0.1);
      display: flex; gap: 12px; align-items: center;
    }

    #user-input {
      flex: 1; padding: 14px 20px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.05); color: var(--text-color); outline: none; font-size: 1rem;
    }

    .action-btn {
      width: 50px; height: 50px; border-radius: 50%; border: none;
      background: var(--user-msg); color: white; cursor: pointer;
      display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .action-btn:hover { transform: scale(1.1); filter: brightness(1.2); }
    .recording { background: #ff4b2b; animation: pulse 1.5s infinite; }

    /* Settings Modal */
    #modal-overlay {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8);
      z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(4px);
    }
    .modal {
      background: var(--bot-msg); padding: 30px; border-radius: 20px;
      width: 90%; max-width: 450px; border: 1px solid rgba(255,255,255,0.1);
    }
    .setting-group { margin-bottom: 20px; }
    .setting-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; opacity: 0.7; }
    .setting-group select, .setting-group input {
      width: 100%; padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.1); color: white;
    }

    .typing { font-size: 0.8rem; opacity: 0.6; margin-left: 10px; }

    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 75, 43, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(255, 75, 43, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 75, 43, 0); } }
  </style>
</head>
<body>

  <header>
    <div class="brand">GEMINI AI</div>
    <div class="nav-tools">
      <button id="export-btn" title="Download Chat">üì•</button>
      <button id="theme-btn">üåô</button>
      <button id="settings-btn">‚öôÔ∏è</button>
      <button id="clear-btn">üóëÔ∏è</button>
    </div>
  </header>

  <div id="chat-container"></div>
  <div id="typing-status" class="typing"></div>

  <div id="input-area">
    <button id="mic-btn" class="action-btn">üéôÔ∏è</button>
    <input type="text" id="user-input" placeholder="Type a message..." autocomplete="off">
    <button id="send-btn" class="action-btn">‚û§</button>
  </div>

  <div id="modal-overlay">
    <div class="modal">
      <h2 style="margin-top:0">Assistant Settings</h2>
      <div class="setting-group">
        <label>AI Intelligence Model</label>
        <select id="model-select">
          <option value="gpt-4o-mini">GPT-4o Mini (Fast)</option>
          <option value="gpt-4o">GPT-4o (Smart)</option>
          <option value="claude-3-5-sonnet">Claude 3.5 Sonnet</option>
        </select>
      </div>
      <div class="setting-group">
        <label>System Instructions (Persona)</label>
        <input type="text" id="system-prompt" placeholder="e.g. You are a pirate who loves coding.">
      </div>
      <div class="setting-group">
        <label><input type="checkbox" id="auto-speak"> Enable Talk-Back (Voice)</label>
      </div>
      <div class="setting-group">
        <label>Memory Strength (Max Context Messages)</label>
        <input type="range" id="context-range" min="2" max="20" value="10">
        <span id="range-val">10</span>
      </div>
      <button id="save-settings" style="width:100%; padding:12px; background:var(--accent); border:none; border-radius:10px; color:white; font-weight:bold; cursor:pointer;">Apply Settings</button>
    </div>
  </div>

  <script>
    // --- State & Config ---
    let config = {
      model: 'gpt-4o-mini',
      systemPrompt: 'You are a helpful AI assistant with contextual memory.',
      autoSpeak: false,
      theme: 'dark',
      maxContext: 10
    };

    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('user-input');
    
    // --- Initialization ---
    window.onload = () => {
      const saved = JSON.parse(localStorage.getItem('gemini_ai_config'));
      if (saved) config = { ...config, ...saved };
      
      applyTheme();
      loadHistory();
      updateSettingsUI();
    };

    function loadHistory() {
      const history = JSON.parse(localStorage.getItem('chatHistory')) || [];
      history.forEach(msg => renderMessage(msg.content, msg.role === 'user' ? 'user' : 'bot', false));
    }

    // --- Core Logic ---
    function renderMessage(text, sender, save = true) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${sender}`;
      
      // Markdown + Highlight
      const rawHtml = marked.parse(text);
      msgDiv.innerHTML = DOMPurify.sanitize(rawHtml);
      
      chatContainer.appendChild(msgDiv);
      msgDiv.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
      chatContainer.scrollTop = chatContainer.scrollHeight;

      if (save) {
        const history = JSON.parse(localStorage.getItem('chatHistory')) || [];
        history.push({ role: sender === 'user' ? 'user' : 'assistant', content: text });
        localStorage.setItem('chatHistory', JSON.stringify(history));
      }
    }

    async function handleSend() {
      const text = userInput.value.trim();
      if (!text) return;

      renderMessage(text, 'user');
      userInput.value = '';
      document.getElementById('typing-status').innerText = "AI is processing...";

      try {
        const history = JSON.parse(localStorage.getItem('chatHistory')) || [];
        const context = history.slice(-(config.maxContext));
        
        // Build the prompt array for Contextual Memory
        const messages = [
          { role: 'system', content: config.systemPrompt },
          ...context
        ];

        const response = await puter.ai.chat(messages, { model: config.model });
        
        document.getElementById('typing-status').innerText = "";
        renderMessage(response, 'bot');

        if (config.autoSpeak) speak(response);
      } catch (err) {
        document.getElementById('typing-status').innerText = "";
        renderMessage("‚ùå Error: " + err.message, 'bot');
      }
    }

    // --- Voice Features ---
    const recognition = window.SpeechRecognition || window.webkitSpeechRecognition ? new (window.SpeechRecognition || window.webkitSpeechRecognition)() : null;
    
    if (recognition) {
      recognition.onresult = (e) => { userInput.value = e.results[0][0].transcript; handleSend(); };
      recognition.onend = () => document.getElementById('mic-btn').classList.remove('recording');
      document.getElementById('mic-btn').onclick = () => {
        document.getElementById('mic-btn').classList.add('recording');
        recognition.start();
      };
    }

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text.replace(/[*#`]/g, ''));
      window.speechSynthesis.speak(utterance);
    }

    // --- UI Helpers ---
    function applyTheme() {
      document.body.className = config.theme;
      document.getElementById('theme-btn').innerText = config.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    function updateSettingsUI() {
      document.getElementById('model-select').value = config.model;
      document.getElementById('system-prompt').value = config.systemPrompt;
      document.getElementById('auto-speak').checked = config.autoSpeak;
      document.getElementById('context-range').value = config.maxContext;
      document.getElementById('range-val').innerText = config.maxContext;
    }

    // --- Event Listeners ---
    document.getElementById('send-btn').onclick = handleSend;
    userInput.onkeypress = (e) => e.key === 'Enter' && handleSend();
    
    document.getElementById('theme-btn').onclick = () => {
      config.theme = config.theme === 'dark' ? 'light' : 'dark';
      localStorage.setItem('gemini_ai_config', JSON.stringify(config));
      applyTheme();
    };

    document.getElementById('settings-btn').onclick = () => document.getElementById('modal-overlay').style.display = 'flex';
    document.getElementById('save-settings').onclick = () => {
      config.model = document.getElementById('model-select').value;
      config.systemPrompt = document.getElementById('system-prompt').value;
      config.autoSpeak = document.getElementById('auto-speak').checked;
      config.maxContext = parseInt(document.getElementById('context-range').value);
      localStorage.setItem('gemini_ai_config', JSON.stringify(config));
      document.getElementById('modal-overlay').style.display = 'none';
    };

    document.getElementById('context-range').oninput = (e) => document.getElementById('range-val').innerText = e.target.value;

    document.getElementById('clear-btn').onclick = () => {
      localStorage.removeItem('chatHistory');
      chatContainer.innerHTML = '';
      renderMessage("Conversation cleared. How can I help you today?", 'bot', false);
    };

    document.getElementById('export-btn').onclick = () => {
      const history = localStorage.getItem('chatHistory');
      const blob = new Blob([history], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'chat_backup.json'; a.click();
    };

    // Close modal on outside click
    window.onclick = (e) => { if(e.target == document.getElementById('modal-overlay')) document.getElementById('modal-overlay').style.display = 'none'; };

  </script>
</body>
</html>
      display: flex;
      flex-direction: column;
      height: 100vh;
      transition: background 0.5s, color 0.5s;
    }

    /* Header & Controls */
    header {
      padding: 15px 20px;
      background: var(--header-bg);
      backdrop-filter: blur(5px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 10;
    }

    .brand {
      font-size: 1.4em;
      font-weight: bold;
      letter-spacing: 1px;
    }

    .controls button {
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      margin-left: 10px;
      color: var(--text-color);
      transition: transform 0.2s;
    }
    .controls button:hover { transform: scale(1.1); }

    /* Chat Area */
    #chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      scroll-behavior: smooth;
    }

    .message {
      max-width: 80%;
      margin: 15px 0;
      padding: 12px 18px;
      border-radius: 12px;
      line-height: 1.5em;
      position: relative;
      animation: fadeIn 0.3s ease-in-out;
      word-wrap: break-word;
    }

    .user {
      background: var(--user-msg);
      color: #fff;
      margin-left: auto;
      border-bottom-right-radius: 2px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .bot {
      background: var(--bot-msg);
      color: var(--text-color);
      margin-right: auto;
      border-bottom-left-radius: 2px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    /* Markdown Styles within Bot Messages */
    .bot pre {
      background: rgba(0,0,0,0.2);
      padding: 10px;
      border-radius: 6px;
      overflow-x: auto;
    }
    .bot code {
      font-family: monospace;
      background: rgba(0,0,0,0.1);
      padding: 2px 4px;
      border-radius: 4px;
    }
    body.light .bot pre { background: #f0f0f0; }

    /* Input Area */
    #input-area {
      display: flex;
      padding: 15px;
      background: var(--header-bg);
      gap: 10px;
      align-items: center;
    }

    #user-input {
      flex: 1;
      padding: 12px;
      border-radius: 25px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1);
      color: var(--text-color);
      outline: none;
      font-size: 1em;
    }
    body.light #user-input {
      background: #fff;
      border: 1px solid #ccc;
    }

    .icon-btn {
      padding: 12px;
      border-radius: 50%;
      border: none;
      width: 45px;
      height: 45px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      transition: background 0.3s;
      color: #fff;
      background: var(--user-msg);
    }
    .icon-btn:hover { filter: brightness(1.1); }
    .icon-btn.recording { background: var(--accent); animation: pulse 1.5s infinite; }

    /* Settings Modal */
    #settings-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: var(--modal-bg);
      padding: 25px;
      border-radius: 15px;
      width: 90%;
      max-width: 400px;
      color: var(--text-color);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      font-size: 1.2em;
      font-weight: bold;
    }

    .setting-item { margin-bottom: 15px; }
    .setting-item label { display: block; margin-bottom: 5px; font-size: 0.9em; opacity: 0.8; }
    .setting-item select, .setting-item input[type="text"] {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #555;
      background: rgba(0,0,0,0.1);
      color: var(--text-color);
      box-sizing: border-box;
    }
    .setting-item input[type="checkbox"] { transform: scale(1.2); margin-right: 10px; }

    #save-settings {
      width: 100%;
      padding: 10px;
      background: var(--user-msg);
      border: none;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
    }

    .typing { font-style: italic; opacity: 0.6; margin: 10px 20px; font-size: 0.9em; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); } }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
  </style>
</head>
<body>

  <header>
    <div class="brand">üí¨ AI Assistant</div>
    <div class="controls">
      <button id="export-btn" title="Export Chat">üì•</button>
      <button id="toggle-mode" title="Toggle Theme">üåô</button>
      <button id="settings-btn" title="Settings">‚öôÔ∏è</button>
      <button id="clear-btn" title="Clear Chat">üóëÔ∏è</button>
    </div>
  </header>

  <div id="chat-container">
    </div>

  <div id="input-area">
    <button id="mic-btn" class="icon-btn" title="Voice Input">üéôÔ∏è</button>
    <input type="text" id="user-input" placeholder="Type or speak..." autocomplete="off" />
    <button id="send-btn" class="icon-btn" title="Send">‚û§</button>
  </div>

  <div id="settings-modal">
    <div class="modal-content">
      <div class="modal-header">
        <span>Settings</span>
        <span id="close-modal" style="cursor:pointer;">&times;</span>
      </div>
      
      <div class="setting-item">
        <label>AI Model</label>
        <select id="model-select">
          <option value="gpt-4o-mini">GPT-4o Mini (Fast)</option>
          <option value="gpt-4o">GPT-4o (Smart)</option>
          <option value="claude-3-5-sonnet">Claude 3.5 Sonnet</option>
          <option value="gemini-1.5-flash">Gemini Flash</option>
        </select>
      </div>

      <div class="setting-item">
        <label>System Persona (Who should I be?)</label>
        <input type="text" id="system-prompt" placeholder="e.g., You are a helpful coding tutor." />
      </div>

      <div class="setting-item" style="display:flex; align-items:center;">
        <input type="checkbox" id="auto-speak" />
        <label for="auto-speak" style="margin:0;">Auto-read responses (TTS)</label>
      </div>

      <div class="setting-item">
        <label>Speech Speed</label>
        <input type="range" id="speech-rate" min="0.5" max="2" step="0.1" value="1" style="width:100%;">
      </div>

      <button id="save-settings">Save & Close</button>
    </div>
  </div>

  <script>
    // --- Elements ---
    const chatContainer = document.getElementById("chat-container");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const micBtn = document.getElementById("mic-btn");
    const toggleMode = document.getElementById("toggle-mode");
    const clearBtn = document.getElementById("clear-btn");
    const exportBtn = document.getElementById("export-btn");
    
    // Modal Elements
    const settingsBtn = document.getElementById("settings-btn");
    const settingsModal = document.getElementById("settings-modal");
    const closeModal = document.getElementById("close-modal");
    const saveSettingsBtn = document.getElementById("save-settings");
    
    // Settings Inputs
    const modelSelect = document.getElementById("model-select");
    const systemPromptInput = document.getElementById("system-prompt");
    const autoSpeakCheckbox = document.getElementById("auto-speak");
    const speechRateInput = document.getElementById("speech-rate");

    // --- State ---
    let config = {
      model: 'gpt-4o-mini',
      systemPrompt: '',
      autoSpeak: false,
      speechRate: 1,
      theme: 'dark'
    };

    // --- Initialization ---
    window.onload = () => {
      // Load Config
      const savedConfig = JSON.parse(localStorage.getItem("ai_chat_config"));
      if (savedConfig) {
        config = { ...config, ...savedConfig };
        applySettingsToUI();
      }
      applyTheme();

      // Load History
      const history = JSON.parse(localStorage.getItem("chatHistory")) || [];
      history.forEach(msg => renderMessage(msg.text, msg.sender, false));
    };

    function applySettingsToUI() {
      modelSelect.value = config.model;
      systemPromptInput.value = config.systemPrompt;
      autoSpeakCheckbox.checked = config.autoSpeak;
      speechRateInput.value = config.speechRate;
    }

    function saveConfig() {
      config.model = modelSelect.value;
      config.systemPrompt = systemPromptInput.value;
      config.autoSpeak = autoSpeakCheckbox.checked;
      config.speechRate = parseFloat(speechRateInput.value);
      localStorage.setItem("ai_chat_config", JSON.stringify(config));
    }

    // --- Core Chat Logic ---
    function renderMessage(text, sender, save = true) {
      const msgDiv = document.createElement("div");
      msgDiv.classList.add("message", sender);
      
      // Parse Markdown safely
      const rawHtml = marked.parse(text);
      const cleanHtml = DOMPurify.sanitize(rawHtml);
      msgDiv.innerHTML = cleanHtml;
      
      chatContainer.appendChild(msgDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      if (save) {
        const history = JSON.parse(localStorage.getItem("chatHistory")) || [];
        history.push({ text, sender });
        localStorage.setItem("chatHistory", JSON.stringify(history));
      }
    }

    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;
      
      renderMessage(text, "user");
      userInput.value = "";
      
      // Show typing indicator
      const typingDiv = document.createElement("div");
      typingDiv.className = "typing";
      typingDiv.innerText = "Thinking...";
      typingDiv.id = "typing-indicator";
      chatContainer.appendChild(typingDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      try {
        // Construct prompt with persona if set
        let finalPrompt = text;
        if (config.systemPrompt) {
            // Note: Puter's simple chat interface might treat this as one block
            finalPrompt = `System Instruction: ${config.systemPrompt}\n\nUser Query: ${text}`;
        }

        const response = await puter.ai.chat(finalPrompt, { model: config.model });
        
        document.getElementById("typing-indicator").remove();
        renderMessage(response, "bot");

        if (config.autoSpeak) {
          speakText(response);
        }

      } catch (err) {
        if(document.getElementById("typing-indicator")) document.getElementById("typing-indicator").remove();
        renderMessage("‚ö†Ô∏è Error: " + err.message, "bot");
      }
    }

    // --- Voice Input (Speech-to-Text) ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      const recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.lang = 'en-US';

      micBtn.addEventListener("click", () => {
        if (micBtn.classList.contains("recording")) {
          recognition.stop();
        } else {
          recognition.start();
        }
      });

      recognition.onstart = () => {
        micBtn.classList.add("recording");
      };

      recognition.onend = () => {
        micBtn.classList.remove("recording");
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        userInput.value = transcript;
        sendMessage(); // Auto-send on voice finish
      };
    } else {
      micBtn.style.display = "none"; // Hide if not supported
    }

    // --- Talk Back (Text-to-Speech) ---
    function speakText(text) {
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel(); // Stop previous
        
        // Strip markdown symbols for cleaner reading
        const plainText = text.replace(/[*#`_]/g, ''); 
        
        const utterance = new SpeechSynthesisUtterance(plainText);
        utterance.rate = config.speechRate;
        // Optional: Select a specific voice here if desired
        window.speechSynthesis.speak(utterance);
      }
    }

    // --- Theme Handling ---
    function applyTheme() {
      if (config.theme === 'light') {
        document.body.classList.add("light");
        toggleMode.textContent = "‚òÄÔ∏è";
      } else {
        document.body.classList.remove("light");
        toggleMode.textContent = "üåô";
      }
    }

    toggleMode.addEventListener("click", () => {
      config.theme = config.theme === 'dark' ? 'light' : 'dark';
      saveConfig();
      applyTheme();
    });

    // --- Settings Modal Logic ---
    settingsBtn.addEventListener("click", () => {
      settingsModal.style.display = "flex";
    });
    
    // Close modal functions
    const hideModal = () => settingsModal.style.display = "none";
    closeModal.addEventListener("click", hideModal);
    settingsModal.addEventListener("click", (e) => {
      if (e.target === settingsModal) hideModal();
    });

    saveSettingsBtn.addEventListener("click", () => {
      saveConfig();
      hideModal();
    });

    // --- Export Chat ---
    exportBtn.addEventListener("click", () => {
      const history = JSON.parse(localStorage.getItem("chatHistory")) || [];
      if (history.length === 0) return alert("No chat history to export.");
      
      const textContent = history.map(m => `[${m.sender.toUpperCase()}]: ${m.text}`).join("\n\n");
      const blob = new Blob([textContent], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "chat-history.txt";
      a.click();
    });

    // --- Event Listeners ---
    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    clearBtn.addEventListener("click", () => {
      localStorage.removeItem("chatHistory");
      chatContainer.innerHTML = "";
      renderMessage("Clean slate! üßπ", "bot", false);
    });

  </script>
</body>
</html>
