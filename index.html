<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced AI Chat Assistant</title>
  <script src="https://js.puter.com/v2/"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
  
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #1f1c2c, #928dab);
      --header-bg: rgba(0,0,0,0.6);
      --user-msg: #4cafef;
      --bot-msg: #2e2e3a;
      --text-color: #fff;
      --accent: #ff6b6b;
      --modal-bg: #2e2e3a;
    }

    body.light {
      --bg-gradient: linear-gradient(135deg, #fdfbfb, #ebedee);
      --header-bg: rgba(255,255,255,0.9);
      --user-msg: #2196f3;
      --bot-msg: #ffffff;
      --text-color: #000;
      --accent: #ff9800;
      --modal-bg: #fff;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-gradient);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      height: 100vh;
      transition: background 0.5s, color 0.5s;
    }

    /* Header & Controls */
    header {
      padding: 15px 20px;
      background: var(--header-bg);
      backdrop-filter: blur(5px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 10;
    }

    .brand {
      font-size: 1.4em;
      font-weight: bold;
      letter-spacing: 1px;
    }

    .controls button {
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      margin-left: 10px;
      color: var(--text-color);
      transition: transform 0.2s;
    }
    .controls button:hover { transform: scale(1.1); }

    /* Chat Area */
    #chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      scroll-behavior: smooth;
    }

    .message {
      max-width: 80%;
      margin: 15px 0;
      padding: 12px 18px;
      border-radius: 12px;
      line-height: 1.5em;
      position: relative;
      animation: fadeIn 0.3s ease-in-out;
      word-wrap: break-word;
    }

    .user {
      background: var(--user-msg);
      color: #fff;
      margin-left: auto;
      border-bottom-right-radius: 2px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .bot {
      background: var(--bot-msg);
      color: var(--text-color);
      margin-right: auto;
      border-bottom-left-radius: 2px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    /* Markdown Styles within Bot Messages */
    .bot pre {
      background: rgba(0,0,0,0.2);
      padding: 10px;
      border-radius: 6px;
      overflow-x: auto;
    }
    .bot code {
      font-family: monospace;
      background: rgba(0,0,0,0.1);
      padding: 2px 4px;
      border-radius: 4px;
    }
    body.light .bot pre { background: #f0f0f0; }

    /* Input Area */
    #input-area {
      display: flex;
      padding: 15px;
      background: var(--header-bg);
      gap: 10px;
      align-items: center;
    }

    #user-input {
      flex: 1;
      padding: 12px;
      border-radius: 25px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1);
      color: var(--text-color);
      outline: none;
      font-size: 1em;
    }
    body.light #user-input {
      background: #fff;
      border: 1px solid #ccc;
    }

    .icon-btn {
      padding: 12px;
      border-radius: 50%;
      border: none;
      width: 45px;
      height: 45px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      transition: background 0.3s;
      color: #fff;
      background: var(--user-msg);
    }
    .icon-btn:hover { filter: brightness(1.1); }
    .icon-btn.recording { background: var(--accent); animation: pulse 1.5s infinite; }

    /* Settings Modal */
    #settings-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: var(--modal-bg);
      padding: 25px;
      border-radius: 15px;
      width: 90%;
      max-width: 400px;
      color: var(--text-color);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      font-size: 1.2em;
      font-weight: bold;
    }

    .setting-item { margin-bottom: 15px; }
    .setting-item label { display: block; margin-bottom: 5px; font-size: 0.9em; opacity: 0.8; }
    .setting-item select, .setting-item input[type="text"] {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #555;
      background: rgba(0,0,0,0.1);
      color: var(--text-color);
      box-sizing: border-box;
    }
    .setting-item input[type="checkbox"] { transform: scale(1.2); margin-right: 10px; }

    #save-settings {
      width: 100%;
      padding: 10px;
      background: var(--user-msg);
      border: none;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
    }

    .typing { font-style: italic; opacity: 0.6; margin: 10px 20px; font-size: 0.9em; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); } }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
  </style>
</head>
<body>

  <header>
    <div class="brand">üí¨ AI Assistant</div>
    <div class="controls">
      <button id="export-btn" title="Export Chat">üì•</button>
      <button id="toggle-mode" title="Toggle Theme">üåô</button>
      <button id="settings-btn" title="Settings">‚öôÔ∏è</button>
      <button id="clear-btn" title="Clear Chat">üóëÔ∏è</button>
    </div>
  </header>

  <div id="chat-container">
    </div>

  <div id="input-area">
    <button id="mic-btn" class="icon-btn" title="Voice Input">üéôÔ∏è</button>
    <input type="text" id="user-input" placeholder="Type or speak..." autocomplete="off" />
    <button id="send-btn" class="icon-btn" title="Send">‚û§</button>
  </div>

  <div id="settings-modal">
    <div class="modal-content">
      <div class="modal-header">
        <span>Settings</span>
        <span id="close-modal" style="cursor:pointer;">&times;</span>
      </div>
      
      <div class="setting-item">
        <label>AI Model</label>
        <select id="model-select">
          <option value="gpt-4o-mini">GPT-4o Mini (Fast)</option>
          <option value="gpt-4o">GPT-4o (Smart)</option>
          <option value="claude-3-5-sonnet">Claude 3.5 Sonnet</option>
          <option value="gemini-1.5-flash">Gemini Flash</option>
        </select>
      </div>

      <div class="setting-item">
        <label>System Persona (Who should I be?)</label>
        <input type="text" id="system-prompt" placeholder="e.g., You are a helpful coding tutor." />
      </div>

      <div class="setting-item" style="display:flex; align-items:center;">
        <input type="checkbox" id="auto-speak" />
        <label for="auto-speak" style="margin:0;">Auto-read responses (TTS)</label>
      </div>

      <div class="setting-item">
        <label>Speech Speed</label>
        <input type="range" id="speech-rate" min="0.5" max="2" step="0.1" value="1" style="width:100%;">
      </div>

      <button id="save-settings">Save & Close</button>
    </div>
  </div>

  <script>
    // --- Elements ---
    const chatContainer = document.getElementById("chat-container");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const micBtn = document.getElementById("mic-btn");
    const toggleMode = document.getElementById("toggle-mode");
    const clearBtn = document.getElementById("clear-btn");
    const exportBtn = document.getElementById("export-btn");
    
    // Modal Elements
    const settingsBtn = document.getElementById("settings-btn");
    const settingsModal = document.getElementById("settings-modal");
    const closeModal = document.getElementById("close-modal");
    const saveSettingsBtn = document.getElementById("save-settings");
    
    // Settings Inputs
    const modelSelect = document.getElementById("model-select");
    const systemPromptInput = document.getElementById("system-prompt");
    const autoSpeakCheckbox = document.getElementById("auto-speak");
    const speechRateInput = document.getElementById("speech-rate");

    // --- State ---
    let config = {
      model: 'gpt-4o-mini',
      systemPrompt: '',
      autoSpeak: false,
      speechRate: 1,
      theme: 'dark'
    };

    // --- Initialization ---
    window.onload = () => {
      // Load Config
      const savedConfig = JSON.parse(localStorage.getItem("ai_chat_config"));
      if (savedConfig) {
        config = { ...config, ...savedConfig };
        applySettingsToUI();
      }
      applyTheme();

      // Load History
      const history = JSON.parse(localStorage.getItem("chatHistory")) || [];
      history.forEach(msg => renderMessage(msg.text, msg.sender, false));
    };

    function applySettingsToUI() {
      modelSelect.value = config.model;
      systemPromptInput.value = config.systemPrompt;
      autoSpeakCheckbox.checked = config.autoSpeak;
      speechRateInput.value = config.speechRate;
    }

    function saveConfig() {
      config.model = modelSelect.value;
      config.systemPrompt = systemPromptInput.value;
      config.autoSpeak = autoSpeakCheckbox.checked;
      config.speechRate = parseFloat(speechRateInput.value);
      localStorage.setItem("ai_chat_config", JSON.stringify(config));
    }

    // --- Core Chat Logic ---
    function renderMessage(text, sender, save = true) {
      const msgDiv = document.createElement("div");
      msgDiv.classList.add("message", sender);
      
      // Parse Markdown safely
      const rawHtml = marked.parse(text);
      const cleanHtml = DOMPurify.sanitize(rawHtml);
      msgDiv.innerHTML = cleanHtml;
      
      chatContainer.appendChild(msgDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      if (save) {
        const history = JSON.parse(localStorage.getItem("chatHistory")) || [];
        history.push({ text, sender });
        localStorage.setItem("chatHistory", JSON.stringify(history));
      }
    }

    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;
      
      renderMessage(text, "user");
      userInput.value = "";
      
      // Show typing indicator
      const typingDiv = document.createElement("div");
      typingDiv.className = "typing";
      typingDiv.innerText = "Thinking...";
      typingDiv.id = "typing-indicator";
      chatContainer.appendChild(typingDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      try {
        // Construct prompt with persona if set
        let finalPrompt = text;
        if (config.systemPrompt) {
            // Note: Puter's simple chat interface might treat this as one block
            finalPrompt = `System Instruction: ${config.systemPrompt}\n\nUser Query: ${text}`;
        }

        const response = await puter.ai.chat(finalPrompt, { model: config.model });
        
        document.getElementById("typing-indicator").remove();
        renderMessage(response, "bot");

        if (config.autoSpeak) {
          speakText(response);
        }

      } catch (err) {
        if(document.getElementById("typing-indicator")) document.getElementById("typing-indicator").remove();
        renderMessage("‚ö†Ô∏è Error: " + err.message, "bot");
      }
    }

    // --- Voice Input (Speech-to-Text) ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      const recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.lang = 'en-US';

      micBtn.addEventListener("click", () => {
        if (micBtn.classList.contains("recording")) {
          recognition.stop();
        } else {
          recognition.start();
        }
      });

      recognition.onstart = () => {
        micBtn.classList.add("recording");
      };

      recognition.onend = () => {
        micBtn.classList.remove("recording");
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        userInput.value = transcript;
        sendMessage(); // Auto-send on voice finish
      };
    } else {
      micBtn.style.display = "none"; // Hide if not supported
    }

    // --- Talk Back (Text-to-Speech) ---
    function speakText(text) {
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel(); // Stop previous
        
        // Strip markdown symbols for cleaner reading
        const plainText = text.replace(/[*#`_]/g, ''); 
        
        const utterance = new SpeechSynthesisUtterance(plainText);
        utterance.rate = config.speechRate;
        // Optional: Select a specific voice here if desired
        window.speechSynthesis.speak(utterance);
      }
    }

    // --- Theme Handling ---
    function applyTheme() {
      if (config.theme === 'light') {
        document.body.classList.add("light");
        toggleMode.textContent = "‚òÄÔ∏è";
      } else {
        document.body.classList.remove("light");
        toggleMode.textContent = "üåô";
      }
    }

    toggleMode.addEventListener("click", () => {
      config.theme = config.theme === 'dark' ? 'light' : 'dark';
      saveConfig();
      applyTheme();
    });

    // --- Settings Modal Logic ---
    settingsBtn.addEventListener("click", () => {
      settingsModal.style.display = "flex";
    });
    
    // Close modal functions
    const hideModal = () => settingsModal.style.display = "none";
    closeModal.addEventListener("click", hideModal);
    settingsModal.addEventListener("click", (e) => {
      if (e.target === settingsModal) hideModal();
    });

    saveSettingsBtn.addEventListener("click", () => {
      saveConfig();
      hideModal();
    });

    // --- Export Chat ---
    exportBtn.addEventListener("click", () => {
      const history = JSON.parse(localStorage.getItem("chatHistory")) || [];
      if (history.length === 0) return alert("No chat history to export.");
      
      const textContent = history.map(m => `[${m.sender.toUpperCase()}]: ${m.text}`).join("\n\n");
      const blob = new Blob([textContent], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "chat-history.txt";
      a.click();
    });

    // --- Event Listeners ---
    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    clearBtn.addEventListener("click", () => {
      localStorage.removeItem("chatHistory");
      chatContainer.innerHTML = "";
      renderMessage("Clean slate! üßπ", "bot", false);
    });

  </script>
</body>
</html>
